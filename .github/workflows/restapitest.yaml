## GITHUB ACTIONS USAGE
# DEPLOY JOBS DEPENDS ON BRANCHES


name: Deploy to production
on:
  push:
    branches:
    - main
    - staging
  workflow_dispatch:

env:
    CLUSTER_NAME: ${{ github.ref_name }}
    REGION: eu-central-1
    APITEST_IMAGE: ghcr.io/Eyup-Devop/restapitest/restapitest-${{ github.ref_name }}
    DEPLOYMENT_MANIFEST_PATH: "${{ github.workspace }}/.${{ github.ref_name }}"
    REGISTRY: ghcr.io

jobs:
    build-restapitest:
        runs-on: ubuntu-latest
        permissions:
          contents: read
          packages: write

        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: tagging image and metadata
            uses: docker/metadata-action@v5
            id: metadata
            with:
              images: ${{ env.APITEST_IMAGE }}
              tags: |
                ${{ github.sha }}
                latest

          - name: login GHCR
            uses: docker/login-action@v3
            with:
              registry: ${{ env.REGISTRY }}
              username: ${{ github.actor }}
              password: ${{ secrets.PERSONEL_TOKEN }}

          - name: build and push image to repository
            uses: int128/kaniko-action@v1
            with:
              context: .
              push: true
              tags: ${{ steps.metadata.outputs.tags }}
              labels: ${{ steps.metadata.outputs.labels }}
              # cache: true
              # cache-repository: ${{ env.APITEST_IMAGE }}/cache
              target: "apitest"

